// 1. C·∫•u h√¨nh k·∫øt n·ªëi
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 2. B·∫£ng Ng∆∞·ªùi d√πng (Users)
model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  fullName  String?
  avatar    String?
  role      Role      @default(USER) // Ph√¢n quy·ªÅn: USER ho·∫∑c ADMIN
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Quan h·ªá ng∆∞·ª£c (User c√≥ nhi·ªÅu kho·∫£n chi v√† task)
  expenses  Expense[]
  tasks     Task[]
  notificationReads NotificationRead[]
  resetToken       String?   // L∆∞u m√£ OTP
  resetTokenExpiry DateTime? // L∆∞u th·ªùi gian h·∫øt h·∫°n c·ªßa m√£
  savingGoals SavingGoal[]
}

// Enum ƒë·ªÉ ph√¢n quy·ªÅn c·ª©ng (Tr√°nh g√µ sai)
enum Role {
  USER
  ADMIN
}

// 3. B·∫£ng Danh m·ª•c chi ti√™u (Categories)
// Admin s·∫Ω t·∫°o s·∫µn c√°c m·ª•c n√†y (ƒÇn u·ªëng, ƒëi l·∫°i...)
model Category {
  id        Int       @id @default(autoincrement())
  name      String
  icon      String?   // L∆∞u t√™n icon ho·∫∑c link ·∫£nh
  type      CategoryType // INCOME (Thu) ho·∫∑c EXPENSE (Chi)
  
  expenses  Expense[]
}

enum CategoryType {
  EXPENSE       // Chi ti√™u
  INCOME        // Thu nh·∫≠p
  DEBT_LENT     // Cho vay (Ti·ªÅn ƒëi ra nh∆∞ng l√† t√†i s·∫£n)
  DEBT_BORROWED // ƒêi vay (Ti·ªÅn ƒëi v√†o nh∆∞ng l√† n·ª£)
  SAVING        // Ti·∫øt ki·ªám
}

// 2. C·∫≠p nh·∫≠t b·∫£ng Expense (Th·ª±c ch·∫•t gi·ªù l√† b·∫£ng Giao D·ªãch - Transaction)
model Expense {
  id          Int      @id @default(autoincrement())
  amount      Decimal  @db.Decimal(15, 2) // TƒÉng gi·ªõi h·∫°n s·ªë ti·ªÅn
  note        String?
  date        DateTime @default(now())
  imageUrl    String?
  
  // üëá TH√äM TR∆Ø·ªúNG N√ÄY: ƒê√°nh d·∫•u chi cho gia ƒë√¨nh
  isFamily    Boolean  @default(false) 

  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])
  lat         Float?   // Vƒ© ƒë·ªô
  lng         Float?   // Kinh ƒë·ªô
  address     String?  // ƒê·ªãa ch·ªâ (t√πy ch·ªçn, l∆∞u t√™n qu√°n)
}

// 5. B·∫£ng C√¥ng vi·ªác (Tasks)
model Task {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  deadline    DateTime?
  priority    Priority @default(MEDIUM)
  status      Status   @default(TODO)
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum Status {
  TODO
  DOING
  DONE
}

// 6. B·∫£ng M·∫´u c√¥ng vi·ªác (Task Templates - Admin t·∫°o)
// V√≠ d·ª•: Template "H·ªçc t·∫≠p" c√≥ priority m·∫∑c ƒë·ªãnh l√† HIGH
model TaskTemplate {
  id              Int      @id @default(autoincrement())
  name            String   // V√≠ d·ª•: "H·ªçc t·∫≠p", "Vi·ªác nh√†"
  defaultPriority Priority @default(MEDIUM)
}

// 7. B·∫£ng Th√¥ng b√°o (Notifications)
model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String
  type      String   @default("INFO")
  isGlobal  Boolean  @default(false) // True: Admin g·ª≠i to√†n h·ªá th·ªëng
  createdAt DateTime @default(now())
  mediaUrl  String?  // Link ·∫£nh ho·∫∑c video
  mediaType String?  // 'IMAGE' ho·∫∑c 'VIDEO'

  isPopup   Boolean  @default(false)
  reads     NotificationRead[]
  // N·∫øu l√† th√¥ng b√°o c√° nh√¢n th√¨ c·∫ßn userId, n·∫øu global th√¨ null
  userId    Int?
}
model SavingGoal {
  id            Int      @id @default(autoincrement())
  name          String   // T√™n: Mua xe, Mua laptop...
  targetAmount  Decimal  @db.Decimal(15, 2) // M·ª•c ti√™u: 30 tri·ªáu
  currentAmount Decimal  @db.Decimal(15, 2) @default(0) // ƒê√£ c√≥: 5 tri·ªáu
  deadline      DateTime? // H·∫°n ch√≥t (Optional)
  
  userId        Int
  user          User     @relation(fields: [userId], references: [id])
}

model NotificationRead {
  id        Int      @id @default(autoincrement())
  userId    Int
  notifId   Int
  readAt    DateTime @default(now())

  user          User         @relation(fields: [userId], references: [id])
  notification  Notification @relation(fields: [notifId], references: [id], onDelete: Cascade)

  @@unique([userId, notifId]) // M·ªôt ng∆∞·ªùi ch·ªâ ƒë·ªçc 1 tin 1 l·∫ßn
}